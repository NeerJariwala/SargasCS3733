<!DOCTYPE html>

<html>

<head>

<meta charset="UTF-8">
<title>Participant GUI</title>
<link rel="stylesheet" href="css/main.css" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>


<script>

	var meeting_url = "https://0h0x7juqld.execute-api.us-east-2.amazonaws.com/Alpha/meeting";
	var getSchedule_url = "https://0h0x7juqld.execute-api.us-east-2.amazonaws.com/Alpha/weeklyschedule";
	var tsID="";
	

	function processCreateResponse(name) {
		// String order: name of person creating meeting

		name = prompt("Please enter your name for your meeting to be created:");
	}

	function processGoResponse(response) {
		var data = JSON.parse(response);
		var body = JSON.parse(data["body"]);
		var code = body["httpCode"];
		
		if(code == 200) {
			var secretCode = body["secretCode"];
			alert("Here is the meeting you requested. Its secret code is: " + secretCode);
		} else if(code == 400) {
			alert("timeslotId error");
		}
	}
	
	function handleRetrieveSchedule() {
		let data = {};
		let form = document.codeForm;
		let date = form.date;
		let secretCode = form.secretCode;
		
		
		data["secretCode"] = secretCode.value;
		data["date"] = date.value;
		
		
		
		

	var js = JSON.stringify(data);
	console.log("JS:" + js);
	var xhr = new XMLHttpRequest();
	xhr.open("POST", getSchedule_url, true);
	
	// send the collected data as JSON
	xhr.send(js);
	
	
	xhr.onloadend = function () {
	    console.log(xhr);
	    console.log(xhr.request);
	    if (xhr.readyState == XMLHttpRequest.DONE) {
	      console.log ("XHR:" + xhr.responseText);
	      	displaySchedule(xhr.responseText);
	    } else {
	      	displaySchedule(xhr.responseText);
	    }
	};
	
	
}
	
	function displaySchedule(response){
		var data = JSON.parse(response);
		let weeks = data["weeks"];
		var week ="";
		if(weeks != null){
			let week = weeks[0];
		}
		else{
			let week = data["week"];
		}
		let days = week["days"];
		let slots = days[0].timeslots;
		let start = slots[0].startTime;
		let duration = slots[0].duration;
		
		var hr = 0;
		var min = 0;
		
		if(duration%60==0){//calculates what it needs to add every row
		hr =1;
		}
		else{
		min = duration;
		}
		
		console.log(week);
		console.log (days);
		console.log(start);
		
		
		var slot_length = days[0].timeslots.length;
		console.log (slot_length);
		
		
		var table = '';
		var label_days = '<tr><td>Time</td><td>Monday</td><td>Tuesday</td><td>Wednesday</td><td>Thursday</td><td>Friday</td></tr>'
		var rows = slot_length;
		var cols = days.length;
		
		
		for(r=0; r<rows;r++){
			table += '<tr>';
			
			for(c=0;c<cols;c++){
				if(c==0){
					if(r==0){
					table += '<td>' + start.hour +':'+ start.minute + '</td>';
						if(days[c].timeslots[r].open == 1){
							tsID = days[c].timeslots[r].timeslotID;
							table += '<td>' + '<input type="button" value="Free" id="meetingBtn" onClick="JavaScript:handleClick(tsID)">' + '</td>';
						}
						else{
							table += '<td>' + 'Taken' + '</td>';
							}
					}
					else{
					table += '<td>' + (start.hour+hr) +':'+ (start.minute+min) + '</td>';
						if(days[c].timeslots[r].open == 1){
						tsID = days[c].timeslots[r].timeslotID;
							table += '<td>' + '<input type="button" value="Free" id="meetingBtn" onClick="JavaScript:handleClick(tsID)">' + '</td>';
						}
						else{
							table += '<td>' + 'Taken' + '</td>';
							}
					}
				}
				else if(days[c].timeslots[r].open == 1){
				tsID = days[c].timeslots[r].timeslotID;
				table += '<td>' + '<input type="button" value="Free" id="meetingBtn" onClick="JavaScript:handleClick(tsID)">' + '</td>';
				}
				else{
				table += '<td>' + 'Taken' + '</td>';
				
				}
			}
			
			table += '</tr>';
			
		}
			
		document.write("<h1>Weekly Schedule</h1>" + '<table border=2>' +label_days+table + '</table>');
		
	}
	
	function handleCancelMeeting() {
		let data = {};

    let secretCode = prompt("Please enter your secret code to cancel meeting:");
    if (secretCode == null){
        alert("Schedule will not be deleted, please try again.");
        return;
    }

		data["secretCode"] = secretCode;

		let js = JSON.stringify(data);
		console.log("JS:" + js);
		let xhr = new XMLHttpRequest();
    xhr.open("DELETE", meeting_url, true);

    xhr.send(js);

		xhr.onloadend = function () {
			console.log(xhr);
			console.log(xhr.request);
			if (xhr.readyState == XMLHttpRequest.DONE) {
				console.log ("XHR:" + xhr.responseText);
						processCancelMeeting(xhr.responseText);
			} else {
					processCancelMeeting(xhr.responseText);
			}
		};
}

function processCancelMeeting(response) {
    let data = JSON.parse(response);

    alert("The meeting has been canceled!");

   
}

	function handleClick(tsID) {
		var data = {};
		data["name"] = prompt("Please enter your name for your meeting to be created:");
		data["timeslotId"] = tsID;
		
	
		var js = JSON.stringify(data);
		console.log("JS:" + js);
		var xhr = new XMLHttpRequest();
		xhr.open("POST", meeting_url, true);
		
		if(data["name"] != null) {
			// send the collected data as JSON
			xhr.send(js);
		
			// This will process results and update HTML as appropriate.
			xhr.onloadend = function () {
				console.log(xhr);
				console.log(xhr.request);
				if (xhr.readyState == XMLHttpRequest.DONE) {
					console.log ("XHR:" + xhr.responseText);
					processGoResponse(xhr.responseText);
				} else {
					processGoResponse(xhr.responseText);
				}
			};
	}
}


</script>
</head>

<body>



<h3>View Schedule:</h3>

<form name="codeForm" method = "post">
 <input type="text" name = "secretCode" value="Secret Code">
 <input type="date" name="date" min="2018-01-01">
 <input type="button" value="Go" id="goBtn" onClick="JavaScript:handleRetrieveSchedule()">
 <br>
 <input type="button" value="Cancel a Meeting" id="cancelBtn" onClick="Javascript:handleCancelMeeting()">
<br><br><br>
<h3>Search:</h3>


<p>Month</p>

<input type="text" id="search-month">

<p>Year</p>

<input type="text" id="search-year">



<p>Day-Of-Week</p>

<input type="text" id="search-dow">

<p>Day-Of-Month</p>

<input type="text" id="search-dom">
<br><br><br>
<input type="button" name = "searchBtn" value="Search">


</body>
</html>
