<!DOCTYPE html>

<html>
<head>

<meta charset="UTF-8">
<title>Organizer GUI</title>
<link rel="stylesheet" href="css/main.css" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" href="">


<script>
const URL = "https://0h0x7juqld.execute-api.us-east-2.amazonaws.com/Alpha/";
const schedule_url = URL + "schedule";
const show_schedule = URL + "weeklyschedule";
const close_url = URL + "closetimeslots";

const EMPTY = `
<tr>
<th><h3> No Schedule Available </h3></th>
<td><p> Make a schedule or search for one to see it here </p></td>
</tr>`;

var startDate;
var secretCode;
var tsID="";

function processGoResponse() {

	alert("Here is the meeting you requested.");
}

function handleClick() {
		let data = {};
	  let form = document.createForm;
	  let name = form.name.value;
	  let startDate = form.startDate.value;
	  let endDate = form.endDate.value;
	  let startHour = form.startHour.value;
	  let endHour = form.endHour.value;
	  let duration = form.duration.value;

	  data["name"] = name;
	  data["startDate"] = startDate;
	  data["endDate"] = endDate;
	  data["startHour"] = startHour;
	  data["endHour"] = endHour;
	  data["duration"] = duration;
		//data["secretCode"] = secretCode;

	  var js = JSON.stringify(data);
	  console.log("JS:" + js);
	  var xhr = new XMLHttpRequest();
	  xhr.open("POST", schedule_url, true);

	  // send the collected data as JSON
	  xhr.send(js);

	  // This will process results and update HTML as appropriate.
	  xhr.onloadend = function () {
	    console.log(xhr);
	    console.log(xhr.request);
	    if (xhr.readyState == XMLHttpRequest.DONE) {
	      console.log ("XHR:" + xhr.responseText);
	      		processCreateResponse(xhr.responseText);
	    } else {
	      	processCreateResponse(xhr.responseText);
	    }
	  };
}

function processCreateResponse(response) {
	var data = JSON.parse(response);
	var body = JSON.parse(data["body"]);
	console.log(body);

	var schedule = body["schedule"];
	var startDate = schedule["startDate"];
	secretCode = body["secretCode"];
	console.log(schedule);
	console.log(secretCode);

	window.sessionStorage.setItem("secretCode", secretCode);
	window.sessionStorage.setItem("schedule", schedule);

	alert("Your schedule has been created! Secret code: " + secretCode);

	handleRetrieveSchedule(secretCode, startDate);
}

function handleDeleteSchedule() {
		let data = {};

    secretCode = prompt("Delete this schedule? \nEnter secret code to confirm");
    if (secretCode == null){
        alert("Schedule will not be deleted, please try again.");
        return;
    }

		data["secretCode"] = secretCode;

		let js = JSON.stringify(data);
		console.log("JS:" + js);
		let xhr = new XMLHttpRequest();
    xhr.open("DELETE", schedule_url, true);

    xhr.send(js);

		xhr.onloadend = function () {
			console.log(xhr);
			console.log(xhr.request);
			if (xhr.readyState == XMLHttpRequest.DONE) {
				console.log ("XHR:" + xhr.responseText);
						processDeleteResponse(xhr.responseText);
			} else {
					processDeleteResponse(xhr.responseText);
			}
		};
}

function processDeleteResponse(response) {
    let data = JSON.parse(response);

    alert("The schedule has been deleted!");

    document.getElementById("schedule").innerHTML = EMPTY;
}

function handleCloseSlot(tsID) {
    let data = {};

		let secretCode = prompt("Please enter your secret code to close timeslot:");
		if (secretCode == null){
				alert("Time slot not closed, please try again.");
				return;
		}

		data["secretCode"] = secretCode;
		data["timeslotId"] = tsID;


    let js = JSON.stringify(data);
		console.log("JS:" + js);
		let xhr = new XMLHttpRequest();

    xhr.open("DELETE", close_url, true);
    xhr.send(js);

		xhr.onloadend = function () {
			console.log(xhr);
			console.log(xhr.request);
			if (xhr.readyState == XMLHttpRequest.DONE) {
				console.log ("XHR:" + xhr.responseText);
						processCloseResponse(xhr.responseText);
			} else {
					processCloseResponse(xhr.responseText);
			}
		};
}

function processCloseResponse(response) {
    let data = JSON.parse(response);

    alert("Time slot has been closed!");

    //Refresh display somehow
}

function handleRetrieveSchedule(secretCode, startDate) {
	let data = {};

	data["secretCode"] = secretCode;
	var year = startDate["year"];
	var month = startDate["month"];
	var day = startDate["day"];

	if (month < 10) {
		var month = "0" + startDate["month"];
	}

	if (day < 10) {
		var day = "0" + startDate["day"];
	}

	startDate = year + "-" + month + "-" + day;
	data["date"] = startDate;


	console.log(secretCode);
	console.log(startDate);

	var js = JSON.stringify(data);
	console.log("JS:" + js);
	var xhr = new XMLHttpRequest();
	xhr.open("POST", show_schedule, true);

	// send the collected data as JSON
	xhr.send(js);


	xhr.onloadend = function () {
			console.log(xhr);
			console.log(xhr.request);
			if (xhr.readyState == XMLHttpRequest.DONE) {
				console.log ("XHR:" + xhr.responseText);
					displaySchedule(xhr.responseText);
			} else {
					displaySchedule(xhr.responseText);
			}
	};
}

function displaySchedule(response){
	var data = JSON.parse(response);

	var week = data["week"];
	var days = week["days"];
	var slots = days[0].timeslots;
	var start = slots[0].startTime;
	var duration = slots[0].duration;

	var hr = 0;
	var min = 0;

	if(duration%60==0){//calculates what it needs to add every row
	hr =1;
	}
	else{
	min = duration;
	}

	console.log(week);
	console.log(days);
	console.log(start);


	var slot_length = days[0].timeslots.length;
	console.log (slot_length);


	var table = '';
	var label_days = '<tr><td>Time</td><td>Monday</td><td>Tuesday</td><td>Wednesday</td><td>Thursday</td><td>Friday</td></tr>'
	var rows = slot_length;
	var cols = days.length;


	for(var r=0; r<rows;r++){
		table += '<tr>';

		for(var c=0;c<cols;c++){
			if(c==0){
				if(r==0){
				table += '<td>' + start.hour +':'+ start.minute + '</td>';
					if(days[c].timeslots[r].open == 1){
						table += '<td>' + '<input type="button" value="Close" id="meetingBtn" onClick="JavaScript:handleCloseSlot(tsID)">' + '</td>';
					}
					else{
						table += '<td>' + 'Closed' + '</td>';
						}
				}
				else{
				table += '<td>' + (start.hour+hr) +':'+ (start.minute+min) + '</td>';
					if(days[c].timeslots[r].open == 1){
						table += '<td>' + '<input type="button" value="Close" id="meetingBtn" onClick="JavaScript:handleCloseSlot(tsID)">' + '</td>';
					}
					else{
						table += '<td>' + 'Closed' + '</td>';
						}
				}
			}
			else if(days[c].timeslots[r].open == 1){
			table += '<td>' + '<input type="button" value="Close" id="meetingBtn" onClick="JavaScript:handleCloseSlot(tsID)">' + '</td>';
			}
			else{
			table += '<td>' + 'Closed' + '</td>';

			}
		}

		table += '</tr>';

	}

	document.write("<h1>Weekly Schedule</h1>" + '<table border=2>' +label_days+table + '</table>');

}


</script>
</head>
<body>

<section id="banner">
	<h2><strong>Meeting Scheduler: </strong> Organizer Portal</h2>
	<p></p>
</section>

<form name="createForm" method="POST" id="createSchedule">
<br><br>
		<p> Schedule Name: <input type="text" name = "name"></p>
		<p>From:<input type="date" name="startDate" min="2018-01-01" max="2050-12-31"></p>
		<p>To:<input type="date" name="endDate" min="2018-01-01" max="2050-12-31"></p>
		<p>From:<input type="number" name="startHour" min="0" max="24">To:<input type="number" name="endHour" min="0" max="24"></p>
		<p>Duration:<input type="number" name="duration" min="0" max="60"> Minutes </p>
		<input type="button" name = "createBtn" value="Create"  onclick="JavaScript:handleClick()">
</form>

<!---

<h2>Go to pre-existing Schedule</h2>

<form name="existingForm" method ="post" id="existingSchedule">
 <input type="text" name = "secretCode" value="Secret Code">
 <input type="button" name = "goBtn" value="Go"  onClick="handleRetrieveSchedule(this)">
</form>
--->

<h3 id="schedule-name"> </h3>

<table id="schedule">
	<tr>
	<th><h3> No Schedule Available </h3></th>
	<td><p> Make a schedule to see it here </p></td>
	</tr>
</table>


<input type="button" onclick="handleDeleteSchedule()" value="Delete Schedule">



</body>
</html>
