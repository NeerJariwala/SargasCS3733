<!DOCTYPE html>

<html>
<head>

<meta charset="UTF-8">
<title>Organizer GUI</title>
<link rel="stylesheet" href="css/main.css" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" href="">


<script>
const URL = "https://0h0x7juqld.execute-api.us-east-2.amazonaws.com/Alpha/";
const schedule_url = URL + "schedule";
const show_schedule = URL + "weeklyschedule";
const close_url = URL + "closetimeslots";

const EMPTY = `
<tr>
<th><h3> No Schedule Available </h3></th>
<td><p> Make a schedule or search for one to see it here </p></td>
</tr>`;


function processGoResponse() {

	alert("Here is the meeting you requested.");
}

function handleClick() {
		let data = {};
	  let form = document.createForm;
	  let name = form.name.value;
	  let startDate = form.startDate.value;
	  let endDate = form.endDate.value;
	  let startHour = form.startHour.value;
	  let endHour = form.endHour.value;
	  let duration = form.duration.value;

	  data["name"] = name;
	  data["startDate"] = startDate;
	  data["endDate"] = endDate;
	  data["startHour"] = startHour;
	  data["endHour"] = endHour;
	  data["duration"] = duration;
		//data["secretCode"] = secretCode;

	  var js = JSON.stringify(data);
	  console.log("JS:" + js);
	  var xhr = new XMLHttpRequest();
	  xhr.open("POST", schedule_url, true);

	  // send the collected data as JSON
	  xhr.send(js);

	  // This will process results and update HTML as appropriate.
	  xhr.onloadend = function () {
	    console.log(xhr);
	    console.log(xhr.request);
	    if (xhr.readyState == XMLHttpRequest.DONE) {
	      console.log ("XHR:" + xhr.responseText);
	      		processCreateResponse(xhr.responseText);
	    } else {
	      	processCreateResponse(xhr.responseText);
	    }
	  };
}

function processCreateResponse(response) {
	var data = JSON.parse(response);

	//let shareCode = data["shareCode"];
	var schedule = data["schedule"];
	var secretCode = data["secretCode"];
	console.log(schedule);
	console.log(secretCode);

	//let week = data["week"];
	//let secretCode = week["secretCode"];

	window.sessionStorage.setItem("secretCode", secretCode);
	//window.sessionStorage.setItem("shareCode", shareCode);
	window.sessionStorage.setItem("schedule", schedule);

	alert("Your schedule has been created! \nSecret code: " + secretCode);

	/* handleRefreshDisplay(1); */
}

/*
function handleRefreshDisplay(week) {
	let data = {};
	data.id = window.sessionStorage.getItem("scheduleId");
	data.week = week;

	let js = JSON.stringify(data);
	console.log("JS:" + js);
	let xhr = new XMLHttpRequest();
	xhr.open("POST", show_schedule, true);

	// send the collected data as JSON
	xhr.send(js);

	// This will process results and update HTML as appropriate.
	xhr.onloadend = function () {
		console.log(xhr);
		console.log(xhr.request);
		if (xhr.readyState == XMLHttpRequest.DONE) {
			console.log ("XHR:" + xhr.responseText);
					processCreateResponse(xhr.responseText);
		} else {
				processCreateResponse(xhr.responseText);
		}
	};

}
*/

function processCreateScheduleResponse(response, week){
		let data = JSON.parse(response);

		let schedule = data.schedule;
		let scheduleId = schedule["scheduleId"];

		x = schedule;

		let table = document.getElementById("schedule");

		let name = schedule.name;
		let startTime = schedule.startTime;
		let endTime = schedule.endTime;
		let duration = schedule.duration;
		let days = schedule.days;

		let thead = document.createElement("thead");
		let tbody = document.createElement("tbody");

		table.innerHTML = "";

		let head = "<th></th>"
		let monday = "<th>" + days[0].id + "Monday" + days[0].date + "</th>";
		let tuesday = "<th>" + days[1].id + "Tuesday" + days[1].date + "</th>";
		let wednesday = "<th>" + days[2].id + "Wednesday" + days[2].date + "</th>";
		let thursday = "<th>" + days[3].id + "Thursday" + days[3].date + "</th>";
		let friday = "<th>" + days[4].id + "Friday" + days[4].date + "</th>";
		thead.innerHMTL = head + monday + tuesday + wednesday + thursday + friday;
		table.appendChild(thead);

		document.querySelector("#schedule-name").innerHTML = "<h3>" + name + "</h3";
		document.querySelector("#schedule-code").innerHTML = "Secret Code: <h3>" + window.sessionStorage.getItem("secretCode") + "</h3 <br> Share Code: <h3>" + shareCode + "</h3>";
}

function handleDeleteSchedule() {
    let data = {};
		let scheduleId = data["scheduleId"];

		window.sessionStorage.setItem("scheduleId", scheduleId);

    let confirmDelete = prompt("Delete this schedule? \nEnter \"yes\" to confirm");
    if (confirmDelete != "yes"){
        alert("Schedule will not be deleted.");
        return;
    }

		let js = JSON.stringify(data);
		console.log("JS:" + js);
		let xhr = new XMLHttpRequest();
    xhr.open("DELETE", schedule_url, true);

    xhr.send(js);

		xhr.onloadend = function () {
			console.log(xhr);
			console.log(xhr.request);
			if (xhr.readyState == XMLHttpRequest.DONE) {
				console.log ("XHR:" + xhr.responseText);
						processDeleteResponse(xhr.responseText);
			} else {
					processDeleteResponse(xhr.responseText);
			}
		};
}

function processDeleteResponse(response) {
    let data = JSON.parse(response);

    alert("The schedule has been deleted!");

    window.sessionStorage.scheduleId = undefined;

    document.getElementById("schedule").innerHTML = EMPTY;
}

function handleCloseSlot(e) {
    let data = {};
    data.scheduleId = e.scheduleId;

    let js = JSON.stringify(data);
		console.log("JS:" + js);
		let xhr = new XMLHttpRequest();

    xhr.open("DELETE", close_url, true);
    xhr.send(js);

		xhr.onloadend = function () {
			console.log(xhr);
			console.log(xhr.request);
			if (xhr.readyState == XMLHttpRequest.DONE) {
				console.log ("XHR:" + xhr.responseText);
						processCloseResponse(xhr.responseText);
			} else {
					processCloseResponse(xhr.responseText);
			}
		};
}

function processCloseResponse(response) {
    let data = JSON.parse(response);

    alert("Time slot has been closed!");

    //Refresh display somehow
}


</script>
</head>
<body>

<section id="banner">
	<h2><strong>Meeting Scheduler: </strong> Organizer Portal</h2>
	<p></p>
</section>

<form name="createForm" method="POST" id="createSchedule">
<br><br>
		<p> Schedule Name: <input type="text" name = "name"></p>
		<p>From:<input type="date" name="startDate" min="2018-01-01"></p>
		<p>To:<input type="date" name="endDate" min="2018-01-01"></p>
		<p>From:<input type="number" name="startHour" min="0" max="24">To:<input type="number" name="endHour" min="0" max="24"></p>
		<p>Duration:<input type="number" name="duration"> Minutes </p>
		<input type="button" name = "createBtn" value="Create"  onclick="JavaScript:handleClick()">
</form>

<!---

<h2>Go to pre-existing Schedule</h2>

<form name="existingForm" method ="post" id="existingSchedule">
 <input type="text" name = "secretCode" value="Secret Code">
 <input type="button" name = "goBtn" value="Go"  onClick="handleRetrieveSchedule(this)">
</form>
--->

<h3 id="schedule-name"> </h3>

<table id="schedule">
	<tr>
	<th><h3> No Schedule Available </h3></th>
	<td><p> Make a schedule to see it here </p></td>
	</tr>
</table>


<input type="button" onclick="handleDeleteSchedule()" value="Delete Schedule">



</body>
</html>
